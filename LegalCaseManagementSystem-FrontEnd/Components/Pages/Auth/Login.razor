@page "/login"
@using LegalCaseManagementSystem_FrontEnd.Models.Auth
@inject HttpClient Http
@inject NavigationManager Navigation
@rendermode InteractiveServer

<div class="login-page">
    <div class="grid-container">
        <div class="image-container">
            <img src="/images/weightscale.png" alt="Login page image" />
        </div>
        <div class="login-container">
            <h2>Sign In</h2>
            <h3>Welcome Mate</h3>

            <label for="username">Username</label>
            <input type="text" @bind="loginModel.Username" id="username" placeholder="Enter your username" required />

            <label for="password">Password</label>
            <input type="password" @bind="loginModel.Password" id="password" placeholder="Enter your password" required/>

            <button @onclick="HandleLogin">Login</button>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-message" style="color:red">@errorMessage</div>
            }

            <h5>Don't have an account? <a href="/register">Sign Up</a></h5>
        </div>
    </div>
</div>

@code {
    private LoginModel loginModel = new LoginModel();
    private string errorMessage = string.Empty;

    private async Task HandleLogin()
    {
        errorMessage = string.Empty;

        try
        {
            // Basic validation
            if (string.IsNullOrWhiteSpace(loginModel.Username))
            {
                errorMessage = "Username is required";
                return;
            }

            if (string.IsNullOrWhiteSpace(loginModel.Password))
            {
                errorMessage = "Password is required";
                return;
            }

            Console.WriteLine($"Attempting login with username: {loginModel.Username}"); // Debug output

            var response = await Http.PostAsJsonAsync("/api/Auth/login", new
            {
                Username = loginModel.Username,
                Password = loginModel.Password
            });

            Console.WriteLine($"Response status: {response.StatusCode}"); // Debug output

            if (response.IsSuccessStatusCode)
            {
                var authResponse = await response.Content.ReadFromJsonAsync<AuthResponse>();
                Console.WriteLine("Login successful"); // Debug output
                Navigation.NavigateTo("/");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error response: {errorContent}"); // Debug output
                errorMessage = "Invalid username or password";
            }
        }
        catch (HttpRequestException httpEx)
        {
            Console.WriteLine($"HTTP Request Exception: {httpEx.Message}");
            errorMessage = "Unable to connect to server. Please check your connection.";
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception: {ex.ToString()}");
            errorMessage = $"Login failed: {ex.Message}";
        }
    }
}