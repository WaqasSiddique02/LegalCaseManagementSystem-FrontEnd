@page "/lawyer/{LawyerId:int}/cases"
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation
@inject DashboardState DashboardState
@using System.Text.Json
@using System.Text.Json.Serialization
@using LegalCaseManagementSystem_FrontEnd.Models
@using LegalCaseManagementSystem_FrontEnd.Services

<LawyerHeader></LawyerHeader>

<div class="dashboard-grid">
    <div class="content-grid">
        <div class="management-actions">
            <div class="row align-items-center">
                <div class="col-md-4 mb-3 mb-md-0">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control" placeholder="Search cases..." @bind="searchTerm" @bind:event="oninput" />
                    </div>
                </div>
                <div class="col-md-4 mb-3 mb-md-0">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-filter"></i>
                        </span>
                        <select class="form-select" @bind="selectedStatus">
                            <option value="">All</option>
                            <option value="Open">Open</option>
                            <option value="InProgress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4 text-md-end">
                
                </div>
            </div>
        </div>

        @if (isLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else if (errorMessage != null)
        {
            <div class="alert alert-danger" role="alert">
                @errorMessage
            </div>
        }
        else
        {
            <div class="case-list-container">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Case ID</th>
                                <th scope="col">Title</th>
                                <th scope="col">Description</th>
                                <th scope="col">Status</th>
                                <th scope="col">Start Date</th>
                                <th scope="col">Client</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var caseItem in FilteredCases)
                            {
                                <tr>
                                    <td>@caseItem.CaseId</td>
                                    <td>@caseItem.Title</td>
                                    <td>@caseItem.Description</td>
                                    <td>
                                        <span class="badge @(GetStatusBadgeClass(caseItem.Status))">
                                            @GetStatusText(caseItem.Status)
                                        </span>
                                    </td>
                                    <td>@caseItem.StartDate.ToString("dd MMM yyyy")</td>
                                    <td>@(caseItem.Client?.FullName ?? "Not assigned")</td>
                                    <td>
                                          <NavLink class="btn btn-primary btn-sm" href="@($"/lawyer/{DashboardState.LawyerId}/cases/{caseItem.CaseId}")">
                                            <i class="bi bi-eye"></i> View
                                        </NavLink>
                           
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                @if (FilteredCases.Count == 0)
                {
                    <div class="no-cases">
                        <i class="fas fa-folder-open"></i>
                        <p>No cases found matching your criteria.</p>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public int LawyerId { get; set; }

    private HttpClient Http => HttpClientFactory.CreateClient("ApiClient");
    private List<Case> allCases = new();
    private List<Case> lawyerCases = new();
    private string searchTerm = string.Empty;
    private string selectedStatus = string.Empty;
    private bool isLoading = false;
    private string? errorMessage;

    private static readonly JsonSerializerOptions jsonOptions = new()
        {
            PropertyNameCaseInsensitive = true,
            Converters = { new JsonStringEnumConverter() }
        };

    protected override async Task OnInitializedAsync()
    {
        DashboardState.LawyerId = LawyerId;
        if (string.IsNullOrEmpty(DashboardState.LawyerName))
        {
            await LoadLawyerDetails();
        }
        DashboardState.OnChange += StateHasChanged;
        await LoadData();
    }

    private async Task LoadLawyerDetails()
    {
        try
        {
            var lawyerResponse = await Http.GetAsync($"/api/Lawyers/{LawyerId}");
            if (lawyerResponse.IsSuccessStatusCode)
            {
                var lawyerContent = await lawyerResponse.Content.ReadAsStringAsync();
                var lawyer = JsonSerializer.Deserialize<Lawyer>(lawyerContent, jsonOptions);
                DashboardState.LawyerName = lawyer?.FullName ?? "Lawyer";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading lawyer details: {ex.Message}";
        }
    }

    private async Task LoadData()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            await LoadCases();
        }
        catch (Exception ex)
        {
            errorMessage = $"Exception loading data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadCases()
    {
        var casesResponse = await Http.GetAsync("/api/Cases?include=client");
        if (!casesResponse.IsSuccessStatusCode)
        {
            errorMessage = $"Error loading cases: {casesResponse.StatusCode}";
            return;
        }

        var casesContent = await casesResponse.Content.ReadAsStringAsync();
        allCases = JsonSerializer.Deserialize<List<Case>>(casesContent, jsonOptions) ?? new();

        // Filter cases by the current lawyer's ID
        lawyerCases = allCases.Where(c => c.LawyerId == LawyerId).ToList();

        DashboardState.Cases = lawyerCases;
        DashboardState.LawyerId = LawyerId;
    }

    private List<Case> FilteredCases => lawyerCases
        .Where(c => (string.IsNullOrEmpty(selectedStatus) || c.Status.ToString() == selectedStatus) &&
                    (string.IsNullOrEmpty(searchTerm) ||
                     c.Title.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                     c.Description.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                     c.Status.ToString().Contains(searchTerm, StringComparison.OrdinalIgnoreCase)))
        .ToList();

    private string GetStatusBadgeClass(CaseStatus status)
    {
        return status switch
        {
            CaseStatus.Open => "status-open",
            CaseStatus.Completed => "status-completed",
            CaseStatus.InProgress => "status-in-progress",
            _ => "badge-secondary"
        };
    }

    private string GetStatusText(CaseStatus status)
    {
        return status switch
        {
            CaseStatus.Open => "Open",
            CaseStatus.Completed => "Completed",
            CaseStatus.InProgress => "In Progress",
            _ => status.ToString()
        };
    }

    private void ViewCase(int caseId)
    {
        Navigation.NavigateTo($"/lawyer/{LawyerId}/cases/{caseId}");
    }

    private void EditCase(int caseId)
    {
        Navigation.NavigateTo($"/lawyer/{LawyerId}/cases/{caseId}/edit");
    }

    private void AddNewCase()
    {
        Navigation.NavigateTo($"/lawyer/{LawyerId}/cases/new");
    }

    public void Dispose()
    {
        DashboardState.OnChange -= StateHasChanged;
    }
}