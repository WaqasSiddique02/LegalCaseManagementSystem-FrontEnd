@using LegalCaseManagementSystem_FrontEnd.Models
@using LegalCaseManagementSystem_FrontEnd.Services
@inject DashboardState DashboardState
@implements IDisposable

<div class="stats-grid">
    <div class="stat-card" style="--card-color: #4e73df">
        <div class="stat-icon">
            <i class="fas fa-gavel"></i>
        </div>
        <div class="stat-info">
            <h3>@ActiveCasesCount</h3>
            <p>Active Cases</p>
            <span class="stat-trend positive">
                <i class="fas fa-arrow-up"></i> @ActiveCasesTrend%
            </span>
        </div>
    </div>
    <div class="stat-card" style="--card-color: #1cc88a">
        <div class="stat-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-info">
            <h3>@CompletedTasksCount</h3>
            <p>Tasks Completed</p>
            <span class="stat-trend positive">
                <i class="fas fa-arrow-up"></i> @CompletedTasksTrend%
            </span>
        </div>
    </div>
    <div class="stat-card" style="--card-color: #f6c23e">
        <div class="stat-icon">
            <i class="fas fa-calendar-alt"></i>
        </div>
        <div class="stat-info">
            <h3>@UpcomingHearingsCount</h3>
            <p>Upcoming Hearings</p>
            <span class="stat-trend negative">
                <i class="fas fa-arrow-down"></i> @HearingsTrend%
            </span>
        </div>
    </div>
    <div class="stat-card" style="--card-color: #e74a3b">
        <div class="stat-icon">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-info">
            <h3>@PendingTasksCount</h3>
            <p>Pending Tasks</p>
            <span class="stat-trend positive">
                <i class="fas fa-arrow-up"></i> @PendingTasksTrend%
            </span>
        </div>
    </div>
</div>

@code {
    // Count only cases assigned to this lawyer
    private int ActiveCasesCount => DashboardState.Cases
        .Where(c => c.LawyerId == DashboardState.LawyerId)
        .Count(c => c.Status == CaseStatus.Open ||
                   c.Status == CaseStatus.Active ||
                   c.Status == CaseStatus.InProgress);

    // Count only tasks from cases assigned to this lawyer
    private int CompletedTasksCount => DashboardState.RecentTasks
        .Where(t => DashboardState.Cases.Any(c =>
            c.CaseId == t.CaseId &&
            c.LawyerId == DashboardState.LawyerId))
        .Count(t => t.Status == "Completed");

    private int PendingTasksCount => DashboardState.RecentTasks
        .Where(t => DashboardState.Cases.Any(c =>
            c.CaseId == t.CaseId &&
            c.LawyerId == DashboardState.LawyerId))
        .Count(t => t.Status == "Pending");

    // Count only hearings from cases assigned to this lawyer
    private int UpcomingHearingsCount => DashboardState.UpcomingHearings
        .Count(h => DashboardState.Cases.Any(c =>
            c.CaseId == h.CaseId &&
            c.LawyerId == DashboardState.LawyerId));

    private int ActiveCasesTrend => CalculateTrend(ActiveCasesCount);
    private int CompletedTasksTrend => CalculateTrend(CompletedTasksCount);
    private int HearingsTrend => CalculateTrend(UpcomingHearingsCount);
    private int PendingTasksTrend => CalculateTrend(PendingTasksCount);

    private int CalculateTrend(int currentCount)
    {
        // TODO: Implement logic to compare with previous data or return a default
        // For now, return a random trend for demonstration
        var random = new Random();
        return random.Next(1, 10);
    }

    protected override void OnInitialized()
    {
        DashboardState.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        DashboardState.OnChange -= StateHasChanged;
    }
}