@page "/cases"
@page "/cases/{caseId:int}"
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer
@using System.Text.Json
@using System.Text.Json.Serialization
@using LegalCaseManagementSystem_FrontEnd.Models

<!-- Dashboard Container -->
<div class="dashboard @(isDarkMode ? "dark-mode" : "")">
    <!-- Header -->
    <header class="dashboard-header">
        <div class="header-left">
            <h1>My Cases <span class="badge">PRO</span></h1>
            <p class="text-muted">Manage your assigned cases</p>
        </div>
        <div class="header-right">
            <button class="btn btn-icon" @onclick="ToggleDarkMode">
                <i class="fas @(isDarkMode ? "fa-sun" : "fa-moon")"></i>
            </button>
            <div class="user-dropdown">
                <img src="https://ui-avatars.com/api/?name=Lawyer&background=4e73df&color=fff" class="user-avatar" />
                <div class="dropdown-content">
                    <a href="#"><i class="fas fa-user"></i> Profile</a>
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <a href="#"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="dashboard-grid">
        @if (!caseId.HasValue)
        {
            <!-- My Cases List -->
            <div class="content-grid">
                <div class="management-actions mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-4 mb-3 mb-md-0">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text" class="form-control" placeholder="Search cases..." @bind="searchTerm" @bind:event="oninput" />
                            </div>
                        </div>
                        <div class="col-md-4 mb-3 mb-md-0">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-filter"></i>
                                </span>
                                <select class="form-select" @bind="selectedStatus">
                                    <option value="">All</option>
                                    <option value="Open">Open</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Closed">Closed</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                @if (isLoading)
                {
                    <div class="text-center py-5">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                }
                else if (errorMessage != null)
                {
                    <div class="alert alert-danger" role="alert">
                        @errorMessage
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-dark table-striped table-hover">
                            <thead>
                                <tr>
                                    <th scope="col">Case ID</th>
                                    <th scope="col">Title</th>
                                    <th scope="col">Description</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Start Date</th>
                                    <th scope="col">Client</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var caseItem in FilteredCases)
                                {
                                    <tr>
                                        <td>@caseItem.CaseId</td>
                                        <td>@caseItem.Title</td>
                                        <td>@caseItem.Description</td>
                                        <td>
                                            <span class="badge @(GetStatusBadgeClass(caseItem.Status))">
                                                @caseItem.Status
                                            </span>
                                        </td>
                                        <td>@caseItem.StartDate.ToString("g")</td>
                                        <td>@(caseItem.Client?.FullName ?? caseItem.ClientId.ToString())</td>
                                        <td>
                                            <a class="btn btn-primary btn-sm" href="/cases/@caseItem.CaseId" title="View Details">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        }
        else if (caseDetails != null)
        {
            <!-- Case Detail -->
            <div class="content-grid">
                <div class="case-detail-card">
                    <div class="card-header">
                        <h3>@caseDetails.Title</h3>
                        <p class="text-muted">@caseDetails.Description</p>
                        <span class="badge @(GetStatusBadgeClass(caseDetails.Status))">
                            @caseDetails.Status
                        </span>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs">
                            <li class="nav-item">
                                <a class="nav-link @(activeTab == "ClientInfo" ? "active" : "")" @onclick="@(() => SetActiveTab("ClientInfo"))">Client Info</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(activeTab == "Tasks" ? "active" : "")" @onclick="@(() => SetActiveTab("Tasks"))">Tasks</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(activeTab == "Hearings" ? "active" : "")" @onclick="@(() => SetActiveTab("Hearings"))">Hearings</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(activeTab == "Documents" ? "active" : "")" @onclick="@(() => SetActiveTab("Documents"))">Documents</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(activeTab == "Invoices" ? "active" : "")" @onclick="@(() => SetActiveTab("Invoices"))">Invoices</a>
                            </li>
                        </ul>
                        <div class="tab-content mt-3">
                            @if (activeTab == "ClientInfo")
                            {
                                <div class="client-info">
                                    <h4>Client Information</h4>
                                    <p><strong>Name:</strong> @(caseDetails.Client?.FullName ?? "N/A")</p>
                                    <p><strong>Contact:</strong> @(caseDetails.Client?.ContactInfo ?? "N/A")</p>
                                </div>
                            }
                            else if (activeTab == "Tasks")
                            {
                                <div class="tasks-list">
                                    <h4>Tasks</h4>
                                    @if (caseDetails.CaseTasks.Any())
                                    {
                                        <div class="table-responsive">
                                            <table class="table table-dark table-striped table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Title</th>
                                                        <th>Description</th>
                                                        <th>Status</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var task in caseDetails.CaseTasks)
                                                    {
                                                        <tr>
                                                            <td>@task.Title</td>
                                                            <td>@task.Description</td>
                                                            <td>
                                                                <span class="badge @(task.Status == "Completed" ? "badge-success" : "badge-warning")">
                                                                    @task.Status
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <button class="btn btn-sm btn-warning" @onclick="() => UpdateTaskStatus(task)">
                                                                    <i class="bi bi-check-circle"></i> Mark as @(task.Status == "Completed" ? "Pending" : "Completed")
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    }
                                    else
                                    {
                                        <p>No tasks available.</p>
                                    }
                                </div>
                            }
                            else if (activeTab == "Hearings")
                            {
                                <div class="hearings-list">
                                    <h4>Hearings</h4>
                                    @if (caseDetails.Hearings.Any())
                                    {
                                        <div class="table-responsive">
                                            <table class="table table-dark table-striped table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Date</th>
                                                        <th>Venue</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var hearing in caseDetails.Hearings.OrderBy(h => h.HearingDate))
                                                    {
                                                        <tr>
                                                            <td>@hearing.HearingDate.ToString("g")</td>
                                                            <td>@hearing.Venue</td>
                                                            <td>
                                                                <span class="badge @(hearing.HearingDate > DateTime.Now ? "badge-info" : "badge-secondary")">
                                                                    @(hearing.HearingDate > DateTime.Now ? "Upcoming" : "Past")
                                                                </span>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    }
                                    else
                                    {
                                        <p>No hearings scheduled.</p>
                                    }
                                </div>
                            }
                            else if (activeTab == "Documents")
                            {
                                <div class="documents-list">
                                    <h4>Documents</h4>
                                    <div class="mb-3">
                                        <input type="file" class="form-control" @onchange="HandleFileUpload" />
                                    </div>
                                    @if (caseDetails.Documents.Any())
                                    {
                                        <div class="table-responsive">
                                            <table class="table table-dark table-striped table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Name</th>
                                                        <th>Uploaded At</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var doc in caseDetails.Documents)
                                                    {
                                                        <tr>
                                                            <td>@doc.Title</td>
                                                            <td>@doc.UploadedAt.ToString("g")</td>
                                                        
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    }
                                    else
                                    {
                                        <p>No documents available.</p>
                                    }
                                </div>
                            }
                            else if (activeTab == "Invoices")
                            {
                                <div class="invoices-list">
                                    <h4>Invoices</h4>
                                    @if (caseDetails.Invoices.Any())
                                    {
                                        <div class="table-responsive">
                                            <table class="table table-dark table-striped table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Invoice ID</th>
                                                        <th>Amount</th>
                                                        <th>Status</th>
                                                        <th>Due Date</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var invoice in caseDetails.Invoices)
                                                    {
                                                        <tr>
                                                            <td>@invoice.InvoiceId</td>
                                                            <td>@invoice.Amount.ToString("C")</td>
                                                            <td>
                                                                <span class="badge @(invoice.Status == "Paid" ? "badge-success" : "badge-warning")">
                                                                    @invoice.Status
                                                                </span>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    }
                                    else
                                    {
                                        <p>No invoices available.</p>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="alert alert-danger" role="alert">
                Case not found.
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public int? caseId { get; set; }

    private HttpClient Http => HttpClientFactory.CreateClient("ApiClient");
    private List<Case> cases = new();
    private Case? caseDetails;
    private string searchTerm = string.Empty;
    private string selectedStatus = string.Empty;
    private bool isDarkMode = false;
    private bool isLoading = false;
    private string? errorMessage;
    private string activeTab = "ClientInfo";

    private static readonly JsonSerializerOptions jsonOptions = new()
        {
            PropertyNameCaseInsensitive = true,
            Converters = { new JsonStringEnumConverter() }
        };

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        if (caseId.HasValue)
        {
            await LoadCaseDetails(caseId.Value);
        }
        else
        {
            await LoadCases();
        }
    }

    private async Task LoadCases()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var response = await Http.GetAsync("/api/Cases");
            if (!response.IsSuccessStatusCode)
            {
                errorMessage = $"Error loading cases: {response.StatusCode}";
                return;
            }
            var content = await response.Content.ReadAsStringAsync();
            cases = JsonSerializer.Deserialize<List<Case>>(content, jsonOptions) ?? new();
        }
        catch (Exception ex)
        {
            errorMessage = $"Exception loading cases: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadCaseDetails(int id)
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var response = await Http.GetAsync($"/api/Cases/{id}");
            if (!response.IsSuccessStatusCode)
            {
                errorMessage = $"Error loading case details: {response.StatusCode}";
                caseDetails = null;
                return;
            }
            var content = await response.Content.ReadAsStringAsync();
            caseDetails = JsonSerializer.Deserialize<Case>(content, jsonOptions);
        }
        catch (Exception ex)
        {
            errorMessage = $"Exception loading case details: {ex.Message}";
            caseDetails = null;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private List<Case> FilteredCases => cases
        .Where(c => (string.IsNullOrEmpty(selectedStatus) || c.Status.ToString() == selectedStatus) &&
                    (string.IsNullOrEmpty(searchTerm) ||
                     c.Title.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                     c.Description.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                     c.Status.ToString().Contains(searchTerm, StringComparison.OrdinalIgnoreCase)))
        .ToList();

    private string GetStatusBadgeClass(CaseStatus status)
    {
        return status switch
        {
            CaseStatus.Open => "badge-open",
            CaseStatus.Closed => "badge-closed",
            CaseStatus.Pending => "badge-pending",
            CaseStatus.Active => "badge-success",
            CaseStatus.InProgress => "badge-info",
            CaseStatus.Completed => "badge-success",
            _ => "badge-secondary"
        };
    }

    private void ToggleDarkMode()
    {
        isDarkMode = !isDarkMode;
        StateHasChanged();
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
        StateHasChanged();
    }

    private async Task UpdateTaskStatus(CaseTask task)
    {
        try
        {
            var updatedTask = new
            {
                Title = task.Title,
                Description = task.Description,
                Status = task.Status == "Completed" ? "Pending" : "Completed"
            };
            var response = await Http.PutAsJsonAsync($"/api/cases/{caseId}/CaseTasks/{task.TaskId}", updatedTask);
            if (response.IsSuccessStatusCode)
            {
                await LoadCaseDetails(caseId!.Value);
            }
            else
            {
                errorMessage = $"Error updating task: {await response.Content.ReadAsStringAsync()}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Exception updating task: {ex.Message}";
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task HandleFileUpload(ChangeEventArgs e)
    {
        await JSRuntime.InvokeVoidAsync("alert", "File upload not implemented in this demo.");
    }
}