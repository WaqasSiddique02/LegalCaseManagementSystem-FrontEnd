@page "/lawyer/{LawyerId:int}/cases/{caseId:int}"
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation
@inject DashboardState DashboardState
@rendermode InteractiveServer
@using System.Text.Json
@using System.Text.Json.Serialization
@using LegalCaseManagementSystem_FrontEnd.Models
@using LegalCaseManagementSystem_FrontEnd.Services

<LawyerHeader></LawyerHeader>

    <!-- Main Content -->
    <div class="dashboard-grid">
        @if (isLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else if (errorMessage != null)
        {
            <div class="alert alert-danger" role="alert">
                @errorMessage
            </div>
        }
        else if (caseDetails != null)
        {
            <!-- Case Detail -->
            <div class="content-grid">
                <div class="case-detail-card">
                    <div class="card-header">
                        <h3>@caseDetails.Title</h3>
                        <p class="text-muted">@caseDetails.Description</p>
                        <span class="badge @(GetStatusBadgeClass(caseDetails.Status))">
                            @GetStatusText(caseDetails.Status)
                        </span>
                        <div class="case-actions mt-3">
                            <button class="btn btn-primary" @onclick="GoBack">
                                <i class="fas fa-arrow-left"></i> Back to Cases
                            </button>
                            <button class="btn btn-outline-primary" @onclick="() => EditCase(caseDetails.CaseId)">
                                <i class="fas fa-edit"></i> Edit Case
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link @(activeTab == "CaseInfo" ? "active" : "")" @onclick="@(() => SetActiveTab("CaseInfo"))" role="tab">Case Info</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(activeTab == "ClientInfo" ? "active" : "")" @onclick="@(() => SetActiveTab("ClientInfo"))" role="tab">Client Info</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(activeTab == "LawyerInfo" ? "active" : "")" @onclick="@(() => SetActiveTab("LawyerInfo"))" role="tab">Lawyer Info</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(activeTab == "Tasks" ? "active" : "")" @onclick="@(() => SetActiveTab("Tasks"))" role="tab">Tasks</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(activeTab == "Hearings" ? "active" : "")" @onclick="@(() => SetActiveTab("Hearings"))" role="tab">Hearings</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(activeTab == "Documents" ? "active" : "")" @onclick="@(() => SetActiveTab("Documents"))" role="tab">Documents</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(activeTab == "Invoices" ? "active" : "")" @onclick="@(() => SetActiveTab("Invoices"))" role="tab">Invoices</a>
                            </li>
                        </ul>
                        <div class="tab-content mt-3">
                            @if (activeTab == "CaseInfo")
                            {
                                <div class="case-info">
                                    <h4>Case Information</h4>
                                    <div class="info-row">
                                        <span class="info-label">Case ID:</span>
                                        <span class="info-value">@caseDetails.CaseId</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Description:</span>
                                        <span class="info-value">@caseDetails.Description</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Start Date:</span>
                                        <span class="info-value">@caseDetails.StartDate.ToString("dd MMM yyyy")</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">End Date:</span>
                                        <span class="info-value">@(caseDetails.EndDate?.ToString("dd MMM yyyy") ?? "Ongoing")</span>
                                    </div>
                                </div>
                            }
                            else if (activeTab == "ClientInfo")
                            {
                                <div class="client-info">
                                    <h4>Client Information</h4>
                                    @if (caseDetails.Client != null)
                                    {
                                        <div class="info-row">
                                            <span class="info-label">Name:</span>
                                            <span class="info-value">@caseDetails.Client.FullName</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Contact:</span>
                                            <span class="info-value">@caseDetails.Client.ContactInfo</span>
                                        </div>
                                    }
                                    else
                                    {
                                        <p>No client assigned.</p>
                                    }
                                </div>
                            }
                            else if (activeTab == "LawyerInfo")
                            {
                                <div class="lawyer-info">
                                    <h4>Lawyer Information</h4>
                                    @if (caseDetails.Lawyer != null)
                                    {
                                        <div class="info-row">
                                            <span class="info-label">Name:</span>
                                            <span class="info-value">@caseDetails.Lawyer.FullName</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Specialization:</span>
                                            <span class="info-value">@caseDetails.Lawyer.Specialization</span>
                                        </div>
                                    }
                                    else
                                    {
                                        <p>No lawyer assigned.</p>
                                    }
                                </div>
                            }
                            else if (activeTab == "Tasks")
                            {
                                <div class="tasks-list">
                                    <h4>Tasks</h4>
                                    <button class="btn btn-primary mb-3" @onclick="AddNewTask">
                                        <i class="fas fa-plus"></i> Add Task
                                    </button>
                                    @if (caseDetails.CaseTasks?.Any() == true)
                                    {
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Title</th>
                                                        <th>Description</th>
                                                        <th>Status</th>
                                                        <th>Created At</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var task in caseDetails.CaseTasks)
                                                    {
                                                        <tr>
                                                            <td>@task.Title</td>
                                                            <td>@task.Description</td>
                                                            <td>
                                                                <span class="badge @(task.Status == "Completed" ? "status-completed" : "status-in-progress")">
                                                                    @task.Status
                                                                </span>
                                                            </td>
                                                            <td>@task.CreatedAt.ToString("dd MMM yyyy")</td>
                                                            <td>
                                                                <button class="btn btn-sm btn-outline-primary" @onclick="() => UpdateTaskStatus(task)">
                                                                    <i class="bi bi-check-circle"></i> Mark as @(task.Status == "Completed" ? "Pending" : "Completed")
                                                                </button>
                                                                <button class="btn btn-sm btn-outline-primary" @onclick="() => EditTask(task)">
                                                                    <i class="fas fa-edit"></i> Edit
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    }
                                    else
                                    {
                                        <p>No tasks available.</p>
                                    }
                                </div>
                            }
                            else if (activeTab == "Hearings")
                            {
                                <div class="hearings-list">
                                    <h4>Hearings</h4>
                                    <button class="btn btn-primary mb-3" @onclick="AddNewHearing">
                                        <i class="fas fa-plus"></i> Schedule Hearing
                                    </button>
                                    @if (caseDetails.Hearings?.Any() == true)
                                    {
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Date</th>
                                                        <th>Venue</th>
                                                        <th>Outcome</th>
                                                        <th>Status</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var hearing in caseDetails.Hearings.OrderBy(h => h.HearingDate))
                                                    {
                                                        <tr>
                                                            <td>@hearing.HearingDate.ToString("dd MMM yyyy h:mm tt")</td>
                                                            <td>@hearing.Venue</td>
                                                            <td>@(string.IsNullOrEmpty(hearing.Outcome) ? "N/A" : hearing.Outcome)</td>
                                                            <td>
                                                                <span class="badge @(hearing.HearingDate > DateTime.Now ? "status-in-progress" : "status-completed")">
                                                                    @(hearing.HearingDate > DateTime.Now ? "Upcoming" : "Past")
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <button class="btn btn-sm btn-outline-primary" @onclick="() => EditHearing(hearing)">
                                                                    <i class="fas fa-edit"></i> Edit
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    }
                                    else
                                    {
                                        <p>No hearings scheduled.</p>
                                    }
                                </div>
                            }
                            else if (activeTab == "Documents")
                            {
                                <div class="documents-list">
                                    <h4>Documents</h4>
                                    <button class="btn btn-primary mb-3" @onclick="AddNewDocument">
                                        <i class="fas fa-plus"></i> Upload Document
                                    </button>
                                    @if (caseDetails.Documents?.Any() == true)
                                    {
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Name</th>
                                                        <th>Uploaded At</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var doc in caseDetails.Documents)
                                                    {
                                                        <tr>
                                                            <td>@doc.Title</td>
                                                            <td>@doc.UploadedAt.ToString("dd MMM yyyy")</td>
                                                            <td>
                                                                <button class="btn btn-sm btn-outline-primary" @onclick="() => ViewDocument(doc)">
                                                                    <i class="fas fa-eye"></i> View
                                                                </button>
                                                                <button class="btn btn-sm btn-outline-primary" @onclick="() => DownloadDocument(doc)">
                                                                    <i class="fas fa-download"></i> Download
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    }
                                    else
                                    {
                                        <p>No documents available.</p>
                                    }
                                </div>
                            }
                            else if (activeTab == "Invoices")
                            {
                                <div class="invoices-list">
                                    <h4>Invoices</h4>
                                    <button class="btn btn-primary mb-3" @onclick="AddNewInvoice">
                                        <i class="fas fa-plus"></i> Create Invoice
                                    </button>
                                    @if (caseDetails.Invoices?.Any() == true)
                                    {
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Title</th>
                                                        <th>Amount</th>
                                                        <th>Issue Date</th>
                                                        <th>Status</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var invoice in caseDetails.Invoices)
                                                    {
                                                        <tr>
                                                            <td>@invoice.InvoiceId</td>
                                                            <td>@invoice.Amount.ToString("C")</td>
                                                            <td>@invoice.IssuedDate.ToString("dd MMM yyyy")</td>
                                                            <td>
                                                                <span class="badge @(invoice.Status == "Paid" ? "status-completed" : "status-in-progress")">
                                                                    @invoice.Status
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <button class="btn btn-sm btn-outline-primary" @onclick="() => EditInvoice(invoice)">
                                                                    <i class="fas fa-edit"></i> Edit
                                                                </button>
                                                                <button class="btn btn-sm btn-outline-primary" @onclick="() => ViewInvoice(invoice)">
                                                                    <i class="fas fa-eye"></i> View
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    }
                                    else
                                    {
                                        <p>No invoices available.</p>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="alert alert-danger" role="alert">
                Case not found.
            </div>
        }
    </div>

@code {
    [Parameter]
    public int LawyerId { get; set; }

    [Parameter]
    public int caseId { get; set; }

    private HttpClient Http => HttpClientFactory.CreateClient("ApiClient");
    private Case? caseDetails;
    private bool isLoading = false;
    private string? errorMessage;
    private string activeTab = "CaseInfo";
    private bool isMobileMenuOpen = false;

    private static readonly JsonSerializerOptions jsonOptions = new()
    {
        PropertyNameCaseInsensitive = true,
        Converters = { new JsonStringEnumConverter() }
    };

    protected override async Task OnInitializedAsync()
    {
        DashboardState.LawyerId = LawyerId;
        if (string.IsNullOrEmpty(DashboardState.LawyerName))
        {
            await LoadLawyerDetails();
        }
        DashboardState.OnChange += StateHasChanged;
        await LoadData();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadData();
    }

    private async Task LoadLawyerDetails()
    {
        try
        {
            var lawyerResponse = await Http.GetAsync($"/api/Lawyers/{LawyerId}");
            if (lawyerResponse.IsSuccessStatusCode)
            {
                var lawyerContent = await lawyerResponse.Content.ReadAsStringAsync();
                var lawyer = JsonSerializer.Deserialize<Lawyer>(lawyerContent, jsonOptions);
                DashboardState.LawyerName = lawyer?.FullName ?? "Lawyer";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading lawyer details: {ex.Message}";
        }
    }

    private async Task LoadData()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            await LoadCaseDetails(caseId);
        }
        catch (Exception ex)
        {
            errorMessage = $"Exception loading data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadCaseDetails(int id)
    {
        try
        {
            var response = await Http.GetAsync($"/api/Cases/{id}?include=client,lawyer,tasks,hearings,documents,invoices");
            if (!response.IsSuccessStatusCode)
            {
                response = await Http.GetAsync($"/api/Cases/{id}");
                if (!response.IsSuccessStatusCode)
                {
                    errorMessage = $"Error loading case details: {response.StatusCode}";
                    caseDetails = null;
                    return;
                }

                var content = await response.Content.ReadAsStringAsync();
                caseDetails = JsonSerializer.Deserialize<Case>(content, jsonOptions);
                if (caseDetails != null)
                {
                    if (caseDetails.LawyerId != LawyerId)
                    {
                        errorMessage = "Case does not belong to this lawyer.";
                        caseDetails = null;
                        return;
                    }
                    caseDetails.CaseTasks = await LoadTasks(id);
                    caseDetails.Hearings = await LoadHearings(id);
                    caseDetails.Documents = await LoadDocuments(id);
                    caseDetails.Invoices = await LoadInvoices(id);
                    caseDetails.Client = await LoadClient(caseDetails.ClientId);
                    caseDetails.Lawyer = await LoadLawyer(caseDetails.LawyerId);
                }
            }
            else
            {
                var content = await response.Content.ReadAsStringAsync();
                caseDetails = JsonSerializer.Deserialize<Case>(content, jsonOptions);
                if (caseDetails != null && caseDetails.LawyerId != LawyerId)
                {
                    errorMessage = "Case does not belong to this lawyer.";
                    caseDetails = null;
                    return;
                }
            }

            if (caseDetails != null)
            {
                caseDetails.CaseTasks ??= new List<CaseTask>();
                caseDetails.Hearings ??= new List<Hearing>();
                caseDetails.Documents ??= new List<Document>();
                caseDetails.Invoices ??= new List<Invoice>();
            }
        }
        catch (JsonException jsonEx)
        {
            errorMessage = $"Data format error: {jsonEx.Message}";
            caseDetails = null;
        }
        catch (Exception ex)
        {
            errorMessage = $"Exception loading case details: {ex.Message}";
            caseDetails = null;
        }
    }

    private async Task<List<CaseTask>> LoadTasks(int caseId)
    {
        var response = await Http.GetAsync($"/api/cases/{caseId}/Tasks");
        if (response.IsSuccessStatusCode)
        {
            var content = await response.Content.ReadAsStringAsync();
            return JsonSerializer.Deserialize<List<CaseTask>>(content, jsonOptions) ?? new();
        }
        return new();
    }

    private async Task<List<Hearing>> LoadHearings(int caseId)
    {
        var response = await Http.GetAsync($"/api/cases/{caseId}/Hearings");
        if (response.IsSuccessStatusCode)
        {
            var content = await response.Content.ReadAsStringAsync();
            return JsonSerializer.Deserialize<List<Hearing>>(content, jsonOptions) ?? new();
        }
        return new();
    }

    private async Task<List<Document>> LoadDocuments(int caseId)
    {
        var response = await Http.GetAsync($"/api/cases/{caseId}/Documents");
        if (response.IsSuccessStatusCode)
        {
            var content = await response.Content.ReadAsStringAsync();
            return JsonSerializer.Deserialize<List<Document>>(content, jsonOptions) ?? new();
        }
        return new();
    }

    private async Task<List<Invoice>> LoadInvoices(int caseId)
    {
        var response = await Http.GetAsync($"/api/cases/{caseId}/Invoices");
        if (response.IsSuccessStatusCode)
        {
            var content = await response.Content.ReadAsStringAsync();
            return JsonSerializer.Deserialize<List<Invoice>>(content, jsonOptions) ?? new();
        }
        return new();
    }

    private async Task<Client?> LoadClient(int clientId)
    {
        if (clientId == 0) return null;
        var response = await Http.GetAsync($"/api/Clients/{clientId}");
        if (response.IsSuccessStatusCode)
        {
            var content = await response.Content.ReadAsStringAsync();
            return JsonSerializer.Deserialize<Client>(content, jsonOptions);
        }
        return null;
    }

    private async Task<Lawyer?> LoadLawyer(int lawyerId)
    {
        if (lawyerId == 0) return null;
        var response = await Http.GetAsync($"/api/Lawyers/{lawyerId}");
        if (response.IsSuccessStatusCode)
        {
            var content = await response.Content.ReadAsStringAsync();
            return JsonSerializer.Deserialize<Lawyer>(content, jsonOptions);
        }
        return null;
    }

    private string GetStatusBadgeClass(CaseStatus status)
    {
        return status switch
        {
            CaseStatus.Open => "status-open",
            CaseStatus.Completed => "status-completed",
            CaseStatus.InProgress => "status-in-progress",
            _ => "badge-secondary"
        };
    }

    private string GetStatusText(CaseStatus status)
    {
        return status switch
        {
            CaseStatus.Open => "Open",
            CaseStatus.Completed => "Completed",
            CaseStatus.InProgress => "In Progress",
            _ => status.ToString()
        };
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
        StateHasChanged();
    }

    private async Task UpdateTaskStatus(CaseTask task)
    {
        try
        {
            var updatedTask = new
            {
                Title = task.Title,
                Description = task.Description,
                Status = task.Status == "Completed" ? "Pending" : "Completed"
            };
            var response = await Http.PutAsJsonAsync($"/api/cases/{caseId}/Tasks/{task.TaskId}", updatedTask);
            if (response.IsSuccessStatusCode)
            {
                await LoadCaseDetails(caseId);
            }
            else
            {
                errorMessage = $"Error updating task: {await response.Content.ReadAsStringAsync()}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Exception updating task: {ex.Message}";
        }
        finally
        {
            StateHasChanged();
        }
    }

    private void GoBack()
    {
        DashboardState.Cases = DashboardState.Cases ?? new List<Case>();
        Navigation.NavigateTo($"/lawyer/{LawyerId}/cases");
    }

    private void EditCase(int caseId)
    {
        Navigation.NavigateTo($"/lawyer/{LawyerId}/cases/{caseId}/edit");
    }

    private void AddNewTask()
    {
        Navigation.NavigateTo($"/lawyer/{LawyerId}/cases/{caseId}/tasks/new");
    }

    private void EditTask(CaseTask task)
    {
        Navigation.NavigateTo($"/lawyer/{LawyerId}/cases/{caseId}/tasks/{task.TaskId}/edit");
    }

    private void AddNewHearing()
    {
        Navigation.NavigateTo($"/lawyer/{LawyerId}/cases/{caseId}/hearings/new");
    }

    private void EditHearing(Hearing hearing)
    {
        Navigation.NavigateTo($"/lawyer/{LawyerId}/cases/{caseId}/hearings/{hearing.HearingId}/edit");
    }

    private void AddNewDocument()
    {
        Navigation.NavigateTo($"/lawyer/{LawyerId}/cases/{caseId}/documents/new");
    }

    private void ViewDocument(Document document)
    {
        Navigation.NavigateTo($"/lawyer/{LawyerId}/cases/{caseId}/documents/{document.DocumentId}/view");
    }

    private void DownloadDocument(Document document)
    {
        Navigation.NavigateTo($"/lawyer/{LawyerId}/cases/{caseId}/documents/{document.DocumentId}/download");
    }

    private void AddNewInvoice()
    {
        Navigation.NavigateTo($"/lawyer/{LawyerId}/cases/{caseId}/invoices/new");
    }

    private void EditInvoice(Invoice invoice)
    {
        Navigation.NavigateTo($"/lawyer/{LawyerId}/cases/{caseId}/invoices/{invoice.InvoiceId}/edit");
    }

    private void ViewInvoice(Invoice invoice)
    {
        Navigation.NavigateTo($"/lawyer/{LawyerId}/cases/{caseId}/invoices/{invoice.InvoiceId}/view");
    }

    private void ToggleMobileMenu()
    {
        isMobileMenuOpen = !isMobileMenuOpen;
        // Mobile menu logic can be implemented in Blazor if needed
    }

    public void Dispose()
    {
        DashboardState.OnChange -= StateHasChanged;
    }
}